<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Smart Hat - Control Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Orbitron', sans-serif;
      margin: 0;
      background: #0a0a0a;
      color: #00ffc8;
    }
    #map {
      height: 50vh;
      width: 100%;
      filter: grayscale(20%) brightness(90%) contrast(120%);
    }
    .container {
      padding: 20px;
      background: #121212;
    }
    .controls, .dropdowns {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }
    button, select, input[type="text"] {
      padding: 12px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
    }
    button {
      background: #00ffc8;
      color: #000;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0,255,200,0.5);
    }
    input[type="text"] {
      width: 60%;
    }
    .log-box {
      background: #fff;
      color: #000;
      padding: 10px;
      border-radius: 8px;
      margin-top: 15px;
      display: none;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="container">
    <div class="controls">
      <input type="text" id="destinationInput" placeholder="Search destination...">
      <button onclick="startVoiceSearch()">ğŸ™ Voice</button>
      <button onclick="toggleVoice()" id="voiceToggle">ğŸ”Š Voice ON</button>
    </div>

    <div class="controls">
      <button onclick="startDetection()">ğŸŸ¢ Start</button>
      <button onclick="stopDetection()">ğŸ”´ Stop</button>
      <button onclick="checkStatus()">ğŸ“Š Status</button>
      <button onclick="toggleLog()">ğŸ“„ Logs</button>
    </div>

    <div class="controls">
      <select id="objectClassSelect">
        <option value="person">person</option>
        <option value="dog">dog</option>
        <option value="cat">cat</option>
        <option value="car">car</option>
        <option value="bus">bus</option>
        <option value="bicycle">bicycle</option>
        <option value="motorcycle">motorcycle</option>
        <option value="truck">truck</option>
        <option value="traffic light">traffic light</option>
        <option value="stop sign">stop sign</option>
      </select>
      <button onclick="updateConfig()">âœ… Apply</button>
    </div>

    <div class="controls">
      <input type="text" id="voiceInput" placeholder="Enter a message">
      <button onclick="sendVoice()">ğŸ“¢ Speak</button>
    </div>

    <div class="controls">
      <button onclick="goTo('Target')">ğŸ¬ Target</button>
      <button onclick="goTo('Walmart')">ğŸ›’ Walmart</button>
      <button onclick="goTo('Pharmacy')">ğŸ’Š Pharmacy</button>
    </div>

    <div id="log" class="log-box">Loading...</div>

    <div style="text-align:center; margin-top: 10px;">
      <a href="/video_feed" target="_blank">ğŸ“¹ Live Stream</a> |
      <a href="/feed" target="_blank">ğŸ“¡ Feed Panel</a>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    let map, directionsService, directionsRenderer, logInterval;
    let voiceEnabled = true;
    const socket = io();

    socket.on('speak', (data) => {
      console.log("[Socket Message]", data.message);
      speak(data.message);
    });

    function initMap() {
      navigator.geolocation.getCurrentPosition(pos => {
        const loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map = new google.maps.Map(document.getElementById("map"), {
          center: loc, zoom: 14
        });
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ map: map });

        const input = document.getElementById("destinationInput");
        const autocomplete = new google.maps.places.Autocomplete(input);
        autocomplete.addListener("place_changed", () => {
          const place = autocomplete.getPlace();
          if (place.geometry) navigateTo(place.geometry.location);
        });

        startDetection();
      });
    }

    function navigateTo(destination) {
      navigator.geolocation.getCurrentPosition(pos => {
        directionsService.route({
          origin: { lat: pos.coords.latitude, lng: pos.coords.longitude },
          destination: destination,
          travelMode: google.maps.TravelMode.WALKING
        }, (res, status) => {
          if (status === "OK") {
            directionsRenderer.setDirections(res);
            speakInstructions(res.routes[0].legs.flatMap(leg => leg.steps));
          }
        });
      });
    }

    function goTo(place) {
      document.getElementById("destinationInput").value = place;
      const service = new google.maps.places.PlacesService(map);
      service.findPlaceFromQuery({ query: place, fields: ["geometry"] }, (results, status) => {
        if (status === google.maps.places.PlacesServiceStatus.OK && results[0])
          navigateTo(results[0].geometry.location);
      });
    }

    function startVoiceSearch() {
      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = 'en-US';
      recognition.start();
      recognition.onresult = e => {
        const text = e.results[0][0].transcript;
        document.getElementById("destinationInput").value = text;
        goTo(text);
      };
    }

    function speakInstructions(steps) {
      steps.forEach((step, i) => {
        setTimeout(() => voiceEnabled && speak(step.instructions.replace(/<[^>]*>/g, '')), i * 6000);
      });
    }

    function speak(text) {
      if ('speechSynthesis' in window)
        speechSynthesis.speak(new SpeechSynthesisUtterance(text));
    }

    function toggleVoice() {
      voiceEnabled = !voiceEnabled;
      document.getElementById("voiceToggle").textContent = voiceEnabled ? "ğŸ”Š Voice ON" : "ğŸ”‡ Voice OFF";
      fetch('/voice_alert_toggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ enabled: voiceEnabled })
      });
    }

    function startDetection() { fetch('/start', { method: 'POST' }); }
    function stopDetection() { fetch('/stop', { method: 'POST' }); }
    function checkStatus() { fetch('/status').then(r => r.json()).then(console.log); }

    function sendVoice() {
      const msg = document.getElementById("voiceInput").value;
      fetch('/speak', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg })
      }).then(res => res.json())
        .then(data => speak(data.message)); // Echo message
    }

    function updateConfig() {
      const cls = document.getElementById("objectClassSelect").value;
      fetch('/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filter_classes: [cls], logging: true })
      });
    }

    function toggleLog() {
      const logBox = document.getElementById("log");
      if (logBox.style.display === "none") {
        logBox.style.display = "block";
        loadLog();
        logInterval = setInterval(loadLog, 5000);
      } else {
        logBox.style.display = "none";
        clearInterval(logInterval);
      }
    }

    function loadLog() {
      fetch('/log')
        .then(r => r.json())
        .then(data => document.getElementById("log").innerHTML = data.reverse().join("<br>"));
    }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBY3Yq8fMunZyBiHqjalocVA1yKyLCi4nw&libraries=places&callback=initMap" async defer></script>
</body>
</html>
