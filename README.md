THE MAIN WORKING CODE IS IN THE final_hat_code
